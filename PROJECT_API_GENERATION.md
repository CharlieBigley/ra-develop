# -------------------------------------------------------------
# Documentation Update
# Date: 2026-03-01
# Author: GPT 4.1
# -------------------------------------------------------------

## Summary

This guide enables rapid, automated creation of Joomla 4.x webservices plugins to expose database tables via REST API. With only three inputs, you can generate all required files and configuration for a working endpoint.

## Workflow Overview

1. Gather the three required inputs (project folder, table name, SQL query).
2. Follow naming conventions and directory structure below.
3. Generate the plugin and component files as described.
4. Install and test the plugin in Joomla.
5. Troubleshoot and verify the endpoint.

## Input Requirements

- **Project Folder:** Should match your Joomla component/project name (e.g., `ra-develop`).
- **Table Name:** Use PascalCase (e.g., `Builds`). Pluralization is required for routes and filenames (e.g., `builds`).
- **SQL Query:** Must return all fields to expose, including necessary joins. Example: `SELECT a.*, t.name FROM table_a LEFT JOIN table_t ON ...`

## File Generation & Placement

- **Plugin Manifest:** `ra_{project}.xml` in `plg_ra_{project}/`
- **Controller:** `{Table}Controller.php` in `com_ra_{project}/api/src/Controller/`
- **Model:** `{Table}sModel.php` in `com_ra_{project}/api/src/Model/`
- **View:** `{Table}s/JsonapiView.php` in `com_ra_{project}/api/src/View/`
- **Provider:** `provider.php` in `com_ra_{project}/api/services/`
- **Extension Class:** `Ra_{project}Component.php` in `com_ra_{project}/api/src/Extension/`

## Troubleshooting & Tips

- **Manifest Naming:** Must be `ra_{project}.xml` (not `plg_ra_{project}.xml`).
- **Route Mismatches:** Ensure pluralization and lowercase for API routes.
- **Permissions:** Check Joomla user and token permissions for API access.
- **Schema Issues:** Match SQL query fields to expected API output.
- **Testing:** Use curl, Postman, or Joomla API browser to verify endpoint.

## Useful Links

- [Joomla Plugin Development](https://docs.joomla.org/Plugin_Development)
- [Joomla Web Services API](https://docs.joomla.org/Web_services_API)
- [Joomla Manifest Files](https://docs.joomla.org/Manifest_files)

## Pluralization Rules

- Table names should be pluralized and lowercase for API routes and filenames (e.g., `Builds` → `builds`).

## Example Testing

Test your endpoint with:
```
curl -i -H "Accept: application/vnd.api+json" -H "X-Joomla-Token: <token>" \
  "https://your.site/api/index.php/v1/ra_develop/builds?limit=10"
```

# Joomla 4.x API Plugin Generation Guide

<!-- Generated by Claude Haiku feb 2026 -->
<!-- Updated by GPT-5-2-Codex 28 feb 2026 -->

## Purpose
This document provides complete templates and instructions for generating Joomla webservices plugins that expose database tables via REST API. It is designed to be self-contained: given only three inputs (project folder, table name, SQL query), all necessary files can be generated.


## Quick Reference: Three Required Inputs

To generate a complete API plugin, provide only:

1. **Parent Project Folder** (e.g., `ra-develop`)
2. **Primary Table Name** (e.g., `Builds`)  
3. **SQL Query** returning all fields to expose (e.g., `SELECT a.*, t.name FROM table_a LEFT JOIN table_t ON ...`)


## Part 1: Naming Conventions & File Structure

### Naming Rules

| Component | Pattern | Example |
|-----------|---------|---------|
| Project Folder | `{project}` | `ra-develop` |
| Plugin Folder | `plg_ra_{project_slug}` | `plg_ra_develop` |
| Component | `com_ra_{project_slug}` | `com_ra_develop` |
| Table Name | `{PascalCase}` | `Builds` |
| Plugin Class | `Ra_{project_slug}` | `Ra_develop` |
| Plugin Namespace | `Ramblers\Plugin\WebServices\Ra_{project_slug}` | `Ramblers\Plugin\WebServices\Ra_develop` |
| Component API Namespace | `Ramblers\Component\Ra_{project_slug}\Api` | `Ramblers\Component\Ra_develop\Api` |
| Plugin Manifest | `ra_{project_slug}.xml` | `ra_develop.xml` |
| API Route | `/api/index.php/v1/ra_{project_slug}/{table_plural_lowercase}` | `/api/index.php/v1/ra_develop/builds` |

**CRITICAL:** Plugin manifest filename MUST be `ra_{project}.xml`, NOT `plg_ra_{project}.xml`. Joomla looks for `{element}.xml`.

### Directory Structure

```
{project}/
├── com_ra_{project}/
│   ├── api/
│   │   ├── services/
│   │   │   └── provider.php
│   │   └── src/
│   │       ├── Controller/
│   │       │   └── {Table}Controller.php
│   │       ├── Extension/
│   │       │   └── Ra_{project}Component.php
│   │       ├── Model/
│   │       │   └── {Table}sModel.php
│   │       └── View/
│   │           └── {Table}s/
│   │               └── JsonapiView.php
│   └── [existing component structure]
│
└── plg_ra_{project}/
    ├── ra_{project}.xml
    ├── services/
    │   └── provider.php
    ├── src/
    │   └── Extension/
    │       └── Ra_{project}.php
    └── language/
        └── en-GB/
            ├── plg_webservices_ra_{project}.ini
            └── plg_webservices_ra_{project}.sys.ini
```

---

## Part 2: SQL Analysis Process

### Step 1: Extract Table Information from SQL

Parse the SQL query to identify:

```
SQL Template:
SELECT {fields} FROM {base_table} [{joins}]

Example:
SELECT DISTINCT a.*, t.name AS extension_type 
FROM #__ra_builds AS a 
LEFT JOIN #__ra_extensions AS e ON e.name=a.component_name 
LEFT JOIN #__ra_extension_types AS t ON t.id=e.extension_type_id
```

### Step 2: Categorize Fields

| Category | Rule | Example |
|----------|------|---------|
| **Base Table Fields** | From primary table alias (e.g., `a.*`) | `id, component_name, version, build_date` |
| **Join Fields** | From JOIN clauses with aliases | `extension_type` (from `t.name AS extension_type`) |
| **Writable Fields** | Base table fields only | Can be updated via API |
| **Read-only Fields** | Calculated/joined fields | Cannot be updated via API |

### Step 3: Determine API Exposure

**All SQL fields** → Available in READ operations (LIST/GET)
**Base table fields only** → Available in WRITE operations (CREATE/UPDATE)

### Example Analysis

```
SQL Query:
SELECT a.id, a.component_name, a.version, a.build_date, 
       a.notes, t.name AS extension_type
FROM #__ra_builds AS a 
LEFT JOIN #__ra_extension_types AS t ON t.id=a.extension_type_id

Result:
BASE TABLE FIELDS (writable):
  - id
  - component_name
  - version
  - build_date
  - notes

JOINED FIELDS (read-only):
  - extension_type

API EXPOSURE:
  - GET /api/.../builds (LIST) → All fields
  - GET /api/.../builds/{id} (GET) → All fields
  - POST /api/.../builds (CREATE) → Base fields only
  - PATCH /api/.../builds/{id} (UPDATE) → Base fields only
```

---

## Part 3: Complete File Templates

### Template 1: Plugin Manifest (`ra_{project}.xml`)

```xml
<?xml version="1.0" encoding="utf-8"?>
<extension type="plugin" group="webservices" method="upgrade">
    <name>PLG_WEBSERVICES_RA_{PROJECT_UPPER}</name>
    <author>Charlie Bigley</author>
    <creationDate>{{CREATION_DATE}}</creationDate>
    <copyright>2026 Charlie Bigley</copyright>
    <license>GNU General Public License version 2 or later; see LICENSE.txt</license>
    <authorEmail>charlie@bigley.me.uk</authorEmail>
    <version>1.0.0</version>
    <description>PLG_WEBSERVICES_RA_{PROJECT_UPPER}_XML_DESCRIPTION</description>
    <namespace path="src">Ramblers\Plugin\WebServices\Ra_{project}</namespace>
    <files>
        <folder plugin="ra_{project}">services</folder>
        <folder>src</folder>
    </files>
    <languages>
        <language tag="en-GB">language/en-GB/plg_webservices_ra_{project}.ini</language>
        <language tag="en-GB">language/en-GB/plg_webservices_ra_{project}.sys.ini</language>
    </languages>
</extension>
```

**Substitutions:**
- `{PROJECT_UPPER}`: Project name in UPPER_SNAKE_CASE (e.g., `RA_DEVELOP`)
- `{project}`: Project name in snake_case (e.g., `ra_develop`)
- `{{CREATION_DATE}}`: Today's date in format `DD Mon YYYY`

---

### Template 2: Plugin Extension Class (`src/Extension/Ra_{project}.php`)

```php
<?php
/**
 * @version    1.0.0
 * @package    com_ra_{project}
 * @author     Charlie Bigley <charlie@bigley.me.uk>
 * @copyright  2026 Charlie Bigley
 * @license    GNU General Public License version 2 or later; see LICENSE.txt
 */

namespace Ramblers\Plugin\WebServices\Ra_{project}\Extension;

defined('_JEXEC') or die;

use Joomla\CMS\Event\Application\BeforeApiRouteEvent;
use Joomla\CMS\Plugin\CMSPlugin;
use Joomla\Event\SubscriberInterface;

/**
 * Web Services adapter for ra_{project} {table_plural}.
 *
 * @since  1.0.0
 */
class Ra_{project} extends CMSPlugin implements SubscriberInterface
{
    /**
     * Returns an array of events this subscriber will listen to.
     *
     * @return  array
     *
     * @since   1.0.0
     */
    public static function getSubscribedEvents(): array
    {
        return [
            'onBeforeApiRoute' => 'onBeforeApiRoute',
        ];
    }

    /**
     * Registers com_ra_{project}'s API routes in the application
     *
     * @param   BeforeApiRouteEvent  $event  The event object
     *
     * @return  void
     *
     * @since   1.0.0
     */
    public function onBeforeApiRoute(BeforeApiRouteEvent $event): void
    {
        $router = $event->getRouter();

        // Create CRUD routes for {table_plural}
        $router->createCRUDRoutes(
            'v1/ra_{project}/{table_plural_lowercase}',
            '{table_plural_lowercase}',
            ['component' => 'com_ra_{project}']
        );
    }
}
```

**Substitutions:**
- `{project}`: snake_case project name
- `{table_plural}`: Plural form of table name (e.g., `Builds`)
- `{table_plural_lowercase}`: Plural table name in lowercase (e.g., `builds`)

---

### Template 3: Plugin Service Provider (`services/provider.php`)

```php
<?php
/**
 * @version    1.0.0
 * @package    com_ra_{project}
 * @author     Charlie Bigley <charlie@bigley.me.uk>
 * @copyright  2026 Charlie Bigley
 * @license    GNU General Public License version 2 or later; see LICENSE.txt
 */

defined('_JEXEC') or die;

use Joomla\CMS\Extension\PluginInterface;
use Joomla\CMS\Factory;
use Joomla\CMS\Plugin\PluginHelper;
use Joomla\DI\Container;
use Joomla\DI\ServiceProviderInterface;
use Joomla\Event\DispatcherInterface;
use Ramblers\Plugin\WebServices\Ra_{project}\Extension\Ra_{project};

return new class () implements ServiceProviderInterface {
    /**
     * Registers the service provider with a DI container.
     *
     * @param   Container  $container  The DI container.
     *
     * @return  void
     *
     * @since   1.0.0
     */
    public function register(Container $container): void
    {
        $container->set(
            PluginInterface::class,
            function (Container $container) {
                $dispatcher = $container->get(DispatcherInterface::class);
                $plugin = new Ra_{project}(
                    $dispatcher,
                    (array) PluginHelper::getPlugin('webservices', 'ra_{project}')
                );
                $plugin->setApplication(Factory::getApplication());
                return $plugin;
            }
        );
    }
};
```

**Substitutions:**
- `{project}`: snake_case project name (appears 3 times)

---

### Template 4: Component API Service Provider (`api/services/provider.php`)

```php
<?php
/**
 * @version    1.0.0
 * @package    com_ra_{project}
 * @author     Charlie Bigley <charlie@bigley.me.uk>
 * @copyright  2026 Charlie Bigley
 * @license    GNU General Public License version 2 or later; see LICENSE.txt
 */

defined('_JEXEC') or die;

use Joomla\CMS\Dispatcher\ComponentDispatcherFactoryInterface;
use Joomla\CMS\Extension\ComponentInterface;
use Joomla\CMS\Extension\Service\Provider\ComponentDispatcherFactory;
use Joomla\CMS\Extension\Service\Provider\MVCFactory;
use Joomla\CMS\MVC\Factory\MVCFactoryInterface;
use Joomla\DI\Container;
use Joomla\DI\ServiceProviderInterface;
use Ramblers\Component\Ra_{project}\Api\Extension\Ra_{project}Component;

return new class implements ServiceProviderInterface
{
  public function register(Container $container)
  {
    $container->registerServiceProvider(new MVCFactory('\\Ramblers\\Component\\Ra_{project}\\Api'));
    $container->registerServiceProvider(new ComponentDispatcherFactory('\\Ramblers\\Component\\Ra_{project}\\Api'));

    $container->set(
      ComponentInterface::class,
      function (Container $container)
      {
        $component = new Ra_{project}Component($container->get(ComponentDispatcherFactoryInterface::class));
        $component->setMVCFactory($container->get(MVCFactoryInterface::class));

        return $component;
      }
    );
  }
};
```

### Template 5: API Component Class (`api/src/Extension/Ra_{project}Component.php`)

```php
<?php
/**
 * @version    1.0.0
 * @package    com_ra_{project}
 * @author     Charlie Bigley <charlie@bigley.me.uk>
 * @copyright  2026 Charlie Bigley
 * @license    GNU General Public License version 2 or later; see LICENSE.txt
 */

namespace Ramblers\Component\Ra_{project}\Api\Extension;

defined('JPATH_PLATFORM') or die;

use Joomla\CMS\Extension\BootableExtensionInterface;
use Joomla\CMS\Extension\MVCComponent;
use Psr\Container\ContainerInterface;

class Ra_{project}Component extends MVCComponent implements BootableExtensionInterface
{
  public function boot(ContainerInterface $container)
  {
    // No API-specific bootstrapping required.
  }
}
```

### Template 6: API Controller (`api/src/Controller/{Table}Controller.php`)

```php
<?php
/**
 * @version    1.0.0
 * @package    com_ra_{project}
 * @author     Charlie Bigley <charlie@bigley.me.uk>
 * @copyright  2026 Charlie Bigley
 * @license    GNU General Public License version 2 or later; see LICENSE.txt
 */

namespace Ramblers\Component\Ra_{project}\Api\Controller;

defined('_JEXEC') or die;

use Joomla\CMS\MVC\Controller\ApiController;

/**
 * The {Table_plural} API controller
 *
 * @since  1.0.0
 */
class {Table}Controller extends ApiController
{
    /**
     * The content type of the item.
     *
     * @var    string
     * @since  1.0.0
     */
    protected $contentType = '{table_plural_lowercase}';

    /**
     * The default view for the display method.
     *
     * @var    string
     * @since  1.0.0
     */
    protected $default_view = '{table_plural_lowercase}';

    /**
     * Authorizes the request (override for temporary public access)
     *
     * @return bool
     * @since 1.0.0
     */
    protected function authorizeRequest()
    {
        // TEMPORARY: Allow public API access for testing
        // TODO: Remove this bypass once token authentication is working
        return true;
    }
}
```

**Substitutions:**
- `{project}`: snake_case project name
- `{Table}`: PascalCase table name (e.g., `Builds`)
- `{table_plural_lowercase}`: plural lowercase (e.g., `builds`)

---

### Template 7: JSON API View (`api/src/View/{Table_plural}/JsonapiView.php`)

```php
<?php
/**
 * @version    1.0.0
 * @package    com_ra_{project}
 * @author     Charlie Bigley <charlie@bigley.me.uk>
 * @copyright  2026 Charlie Bigley
 * @license    GNU General Public License version 2 or later; see LICENSE.txt
 */

namespace Ramblers\Component\Ra_{project}\Api\View\{Table_plural};

defined('_JEXEC') or die;

use Joomla\CMS\MVC\View\JsonApiView as BaseApiView;

/**
 * JSON API view for {table_plural}
 *
 * @since  1.0.0
 */
class JsonapiView extends BaseApiView
{
    /**
     * Fields to render when fetching a single record.
     * Includes fields from joined tables (read-only).
     *
     * @var array
     * @since 1.0.0
     */
    protected $fieldsToRenderItem = [
        {{FIELDS_ITEM}}
    ];

    /**
     * Fields to render when fetching multiple records.
     * Can include calculated/joined fields.
     *
     * @var array
     * @since 1.0.0
     */
    protected $fieldsToRenderList = [
        {{FIELDS_LIST}}
    ];
}
```

**Substitutions:**
- `{project}`: snake_case project name
- `{Table_plural}`: PascalCase plural table name
- `{{FIELDS_ITEM}}`: All fields from SQL query (comma-separated quoted strings)
- `{{FIELDS_LIST}}`: Same fields or subset for list view

**Example for Builds table:**
```php
protected $fieldsToRenderItem = [
    'id',
    'component_name',
    'version',
    'build_date',
    'notes',
    'extension_type',
];

protected $fieldsToRenderList = [
    'id',
    'component_name',
    'version',
    'build_date',
    'extension_type',
];
```

---

## Part 4: Generation Checklist

Use this checklist when generating a new API plugin:

- [ ] **Parse SQL Query**
  - [ ] Identify base table and alias
  - [ ] List all base table fields
  - [ ] Identify joined tables and aliases
  - [ ] List all joined fields with aliases

- [ ] **Create Plugin Directory Structure**
  - [ ] Create `plg_ra_{project}/`
  - [ ] Create `plg_ra_{project}/src/Extension/`
  - [ ] Create `plg_ra_{project}/services/`
  - [ ] Create `plg_ra_{project}/language/en-GB/`

- [ ] **Create Component API Structure**
  - [ ] Create `com_ra_{project}/api/services/`
  - [ ] Create `com_ra_{project}/api/src/Controller/`
  - [ ] Create `com_ra_{project}/api/src/Extension/`
  - [ ] Create `com_ra_{project}/api/src/Model/`
  - [ ] Create `com_ra_{project}/api/src/View/{Table_plural}/`

- [ ] **Generate Plugin Files**
  - [ ] `ra_{project}.xml` (manifest)
  - [ ] `src/Extension/Ra_{project}.php`
  - [ ] `services/provider.php`
  - [ ] Language files (ini/sys.ini)

- [ ] **Generate Component API Files**
  - [ ] `api/services/provider.php`
  - [ ] `api/src/Extension/Ra_{project}Component.php`
  - [ ] `api/src/Controller/{Table}Controller.php`
  - [ ] `api/src/View/{Table_plural}/JsonapiView.php`
  - [ ] Optional: `api/src/Model/{Table_plural}Model.php`

- [ ] **Update Manifests**
  - [ ] Update component manifest API section to include only:
        - `<folder>services</folder>`
        - `<folder>src</folder>`
  - [ ] Do not include `api/Controller`, `api/Model`, or `api/View` at the API root

- [ ] **Test**
  - [ ] Install plugin
  - [ ] Install/update component
  - [ ] Verify routes: `/api/index.php/v1/ra_{project}/{table_plural_lowercase}`
  - [ ] Test GET/POST/PATCH/DELETE operations
  - [ ] Check permissions/authentication as needed

---

## Part 5: Real-World Example: ra-develop

### Input Parameters
```
Parent Project:    ra-develop
Table:             Builds
SQL Query:         SELECT DISTINCT a.*, t.name AS extension_type 
                   FROM #__ra_builds AS a 
                   LEFT JOIN #__ra_extensions AS e 
                     ON e.name=a.component_name 
                   LEFT JOIN #__ra_extension_types AS t 
                     ON t.id=e.extension_type_id
```

### Derived Values
```
Plugin Folder:              plg_ra_develop
Plugin Class:               Ra_develop
Plugin Namespace:           Ramblers\Plugin\WebServices\Ra_develop
Component API Namespace:    Ramblers\Component\Ra_develop\Api
API Route:                  /api/index.php/v1/ra_develop/builds
Base Table:                 #__ra_builds
Base Table Fields:          id, component_name, version, build_date, 
                            notes, replace, created, modified, etc.
Joined Fields (read-only):  extension_type
```

### Generated Files

**Plugin files:**
- `plg_ra_develop/ra_develop.xml`
- `plg_ra_develop/src/Extension/Ra_develop.php`
- `plg_ra_develop/services/provider.php`

**Component API files:**
- `com_ra_develop/api/src/Controller/BuildsController.php`
- `com_ra_develop/api/src/View/Builds/JsonapiView.php`

---

## Part 6: Key Technical Notes

### Manifest Filename
- **Correct**: `ra_develop.xml`
- **Wrong**: `plg_ra_develop.xml`
- Joomla looks for `{element}.xml`, not `{prefix}_{element}.xml`

### Autoloader Registration
When plugin is installed, Joomla automatically registers PSR-4 namespace:
```
Ramblers\Plugin\WebServices\Ra_develop\
  → {JPATH_PLUGINS}/webservices/ra_develop/src/
```

This is why manually editing `autoload_psr4.php` should not be necessary.

### API Authentication
By default, API requires valid Joomla token in `X-Joomla-Token` header. For testing/interim purposes, override `authorizeRequest()` to return `true`.

### JSON:API Format
Responses follow JSON:API specification (https://jsonapi.org/). Fields are exposed as attributes in the `data` object.

### URL Format
- **Correct**: `/api/index.php/v1/ra_develop/builds`
- **Wrong**: `/api/v1/ra_develop/builds` (no index.php)

---

## Part 7: Future Regeneration

To regenerate this plugin in a future session, provide only:

1. **Project folder path**: `/Users/charlie/git/ra-develop`
2. **Table name**: `Builds`
3. **SQL query**: The query from Part 5

Reference this document's templates and follow the Generation Checklist (Part 4) to recreate all necessary files.

